<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Homeworlds Arena</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
:root{--bg:#060912;--panel:#0c1120;--border:#1c2840;--text:#a8c0e0;--bright:#ddeeff;--red:#ff3344;--blue:#2266ff;--yellow:#ffcc00;--green:#22dd77;--p1:#4488ff;--p2:#ff4455}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{min-height:100%;background:var(--bg);color:var(--text);font-family:'Share Tech Mono',monospace;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;background-image:radial-gradient(circle at 10% 15%,rgba(255,255,255,.6) 1px,transparent 1px),radial-gradient(circle at 30% 70%,rgba(255,255,255,.4) 1px,transparent 1px),radial-gradient(circle at 55% 8%,rgba(255,255,255,.5) 1px,transparent 1px),radial-gradient(circle at 75% 85%,rgba(255,255,255,.6) 1px,transparent 1px),radial-gradient(circle at 90% 30%,rgba(255,255,255,.4) 1px,transparent 1px),radial-gradient(circle at 42% 45%,rgba(255,255,255,.3) 1px,transparent 1px),radial-gradient(circle at 18% 88%,rgba(255,255,255,.5) 1px,transparent 1px),radial-gradient(circle at 65% 55%,rgba(255,255,255,.4) 1px,transparent 1px),radial-gradient(circle at 85% 65%,rgba(255,255,255,.3) 1px,transparent 1px),radial-gradient(circle at 5% 50%,rgba(255,255,255,.5) 1px,transparent 1px),radial-gradient(circle at 50% 90%,rgba(255,255,255,.4) 1px,transparent 1px),radial-gradient(circle at 22% 35%,rgba(255,255,255,.3) 1px,transparent 1px),radial-gradient(circle at 70% 20%,rgba(255,255,255,.5) 1px,transparent 1px),radial-gradient(circle at 38% 62%,rgba(255,255,255,.4) 1px,transparent 1px),radial-gradient(circle at 92% 48%,rgba(255,255,255,.6) 1px,transparent 1px);background-size:900px 900px}
nav{position:fixed;top:0;left:0;right:0;z-index:100;display:flex;align-items:center;justify-content:space-between;padding:14px 40px;background:rgba(6,9,18,.88);backdrop-filter:blur(12px);border-bottom:1px solid rgba(28,40,64,.5)}
.nav-logo{font-family:'Orbitron',sans-serif;font-weight:900;font-size:16px;letter-spacing:4px;color:var(--bright);text-decoration:none}
.nav-logo span{color:var(--p1)}
.btn{padding:9px 22px;border-radius:4px;cursor:pointer;font-family:'Orbitron',sans-serif;font-size:11px;letter-spacing:2px;transition:all .2s;text-decoration:none;display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:rgba(255,255,255,.03);color:var(--text)}
.btn:hover{background:rgba(255,255,255,.08);border-color:#3a5080;color:var(--bright)}
.btn-primary{background:rgba(68,136,255,.15);border-color:var(--p1);color:var(--p1)}
.btn-primary:hover{background:rgba(68,136,255,.3);box-shadow:0 0 20px rgba(68,136,255,.4)}
.btn-large{padding:15px 44px;font-size:13px;letter-spacing:3px}
.hero{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:120px 40px 80px;position:relative;z-index:1;text-align:center}
.hero-eyebrow{font-size:11px;letter-spacing:6px;color:#4a6080;margin-bottom:24px;text-transform:uppercase}
.hero-title{font-family:'Orbitron',sans-serif;font-weight:900;font-size:clamp(42px,8vw,96px);letter-spacing:6px;color:var(--bright);line-height:1;margin-bottom:12px}
.hero-title .accent{color:var(--p1)}
.hero-subtitle{font-size:13px;color:#506080;letter-spacing:2px;margin-bottom:60px;line-height:1.8}
.hero-pieces{position:absolute;inset:0;pointer-events:none;overflow:hidden}
.piece-float{position:absolute;opacity:.12;animation:floatPiece linear infinite}
@keyframes floatPiece{0%{transform:translateY(0) rotate(0deg);opacity:0}10%{opacity:.12}90%{opacity:.12}100%{transform:translateY(-120px) rotate(20deg);opacity:0}}

/* ── Login card ── */
.login-card{background:rgba(12,17,32,.95);border:1px solid var(--border);border-radius:12px;padding:32px;width:100%;max-width:380px;backdrop-filter:blur(20px);box-shadow:0 0 60px rgba(68,136,255,.06)}
.login-title{font-family:'Orbitron',sans-serif;font-size:13px;letter-spacing:3px;color:var(--bright);margin-bottom:6px;text-align:center}
.login-sub{font-size:11px;color:#4a6080;text-align:center;margin-bottom:24px;line-height:1.6}
.auth-tabs{display:flex;border:1px solid var(--border);border-radius:5px;overflow:hidden;margin-bottom:20px}
.auth-tab{flex:1;padding:9px;font-family:'Orbitron',sans-serif;font-size:10px;letter-spacing:1.5px;cursor:pointer;border:none;background:none;color:#4a6080;transition:all .15s;text-align:center}
.auth-tab.active{background:rgba(68,136,255,.12);color:var(--p1)}
.auth-tab:hover:not(.active){background:rgba(255,255,255,.04);color:var(--text)}
.btn-google{width:100%;padding:13px 20px;background:rgba(255,255,255,.05);border:1px solid #3a5080;color:var(--bright);font-family:'Orbitron',sans-serif;font-size:11px;letter-spacing:2px;border-radius:5px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:all .2s}
.btn-google:hover{background:rgba(255,255,255,.1);border-color:var(--bright)}
.login-divider{display:flex;align-items:center;gap:12px;margin:16px 0;font-size:10px;color:#2a3850;letter-spacing:2px}
.login-divider::before,.login-divider::after{content:'';flex:1;height:1px;background:var(--border)}
.auth-field{margin-bottom:12px}
.auth-label{font-size:10px;letter-spacing:1.5px;color:#4a6080;margin-bottom:6px;display:block}
.auth-input{width:100%;padding:11px 14px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:5px;color:var(--bright);font-family:'Share Tech Mono',monospace;font-size:13px;outline:none;transition:border-color .2s;letter-spacing:.5px}
.auth-input:focus{border-color:var(--p1)}
.auth-input.err{border-color:var(--p2)}
.auth-input.ok{border-color:rgba(34,221,119,.6)}
.pw-strength{height:3px;border-radius:2px;margin-top:5px;transition:all .3s;background:rgba(255,255,255,.05)}
.pw-strength.weak{background:var(--p2);width:33%}
.pw-strength.medium{background:var(--yellow);width:66%}
.pw-strength.strong{background:var(--green);width:100%}
.auth-check-row{display:flex;align-items:flex-start;gap:10px;margin:10px 0 4px}
.auth-check-row input[type=checkbox]{width:16px;height:16px;flex-shrink:0;margin-top:2px;accent-color:var(--p1);cursor:pointer}
.auth-check-row label{font-size:11px;color:#4a6080;line-height:1.5;cursor:pointer}
.auth-check-row a{color:#3a6090;text-decoration:none}
.auth-check-row a:hover{color:var(--text)}
.btn-auth{width:100%;padding:13px;margin-top:8px;cursor:pointer;background:rgba(68,136,255,.15);border:1px solid rgba(68,136,255,.5);color:var(--p1);font-family:'Orbitron',sans-serif;font-size:11px;letter-spacing:2px;border-radius:5px;transition:all .15s}
.btn-auth:hover:not(:disabled){background:rgba(68,136,255,.28);box-shadow:0 0 16px rgba(68,136,255,.25)}
.btn-auth:disabled{opacity:.35;cursor:not-allowed}
.auth-status{font-size:11px;letter-spacing:.5px;min-height:16px;margin-top:8px;text-align:center;line-height:1.5}
.auth-status.err{color:var(--p2)}
.auth-status.ok{color:var(--green)}
.auth-status.info{color:#4a7090}
.auth-switch{font-size:11px;color:#3a5060;text-align:center;margin-top:14px}
.auth-switch a{color:#3a6090;cursor:pointer;text-decoration:none}
.auth-switch a:hover{color:var(--text)}
.legal-note{font-size:10px;color:#253040;text-align:center;margin-top:12px;line-height:1.7}
.legal-note a{color:#2a4060;text-decoration:none}
.legal-note a:hover{color:#4a6080}

/* ── Verify panel ── */
#verify-panel{display:none}
.verify-email-hint{font-size:11px;color:#4a7090;text-align:center;margin-bottom:20px;line-height:1.7}
.verify-email-hint strong{color:var(--bright)}
.code-input-row{display:flex;gap:8px;justify-content:center;margin:20px 0 8px}
.code-digit{width:44px;height:54px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:6px;text-align:center;color:var(--bright);font-family:'Orbitron',sans-serif;font-size:22px;font-weight:700;outline:none;transition:border-color .15s;caret-color:transparent}
.code-digit:focus{border-color:var(--p1);background:rgba(68,136,255,.06)}
.code-digit.filled{border-color:rgba(68,136,255,.5)}
@keyframes shake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-6px)}40%,80%{transform:translateX(6px)}}
.code-input-row.shake{animation:shake .35s ease}
.resend-row{text-align:center;margin-top:8px;margin-bottom:4px}
.btn-resend{background:none;border:none;color:#3a6090;font-family:'Share Tech Mono',monospace;font-size:11px;cursor:pointer;letter-spacing:.5px;padding:4px}
.btn-resend:hover:not(:disabled){color:var(--text)}
.btn-resend:disabled{color:#253040;cursor:not-allowed}
.resend-timer{font-size:11px;color:#253040;letter-spacing:.5px}

/* ── How to play ── */
.how-section{max-width:920px;margin:0 auto;padding:80px 40px;position:relative;z-index:1}
.section-eyebrow{font-size:10px;letter-spacing:5px;color:#4a6080;margin-bottom:16px;text-transform:uppercase}
.section-title{font-family:'Orbitron',sans-serif;font-size:24px;font-weight:700;color:var(--bright);margin-bottom:48px;letter-spacing:2px}
.powers-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:48px}
.power-card{background:rgba(12,17,32,.85);border:1px solid var(--border);border-radius:8px;padding:20px 16px;text-align:center;transition:border-color .2s,box-shadow .2s}
.power-card:hover{border-color:var(--power-color,#3a5080);box-shadow:0 0 16px var(--power-glow,transparent)}
.power-icon{width:48px;height:48px;border-radius:50%;margin:0 auto 12px;background:var(--power-bg,rgba(255,255,255,.05));border:1px solid var(--power-color,#3a5080);display:flex;align-items:center;justify-content:center;overflow:hidden}
.power-icon img{display:block}
.power-name{font-family:'Orbitron',sans-serif;font-size:10px;letter-spacing:2px;color:var(--power-color,var(--text));margin-bottom:6px}
.power-desc{font-size:11px;color:#4a6080;line-height:1.6}
.attr-strip{max-width:720px;margin:0 auto 80px;padding:0 40px;position:relative;z-index:1;text-align:center;font-size:12px;color:#3a5060;letter-spacing:1px;line-height:2}
.attr-strip a{color:#4a7090;text-decoration:none}
.attr-strip a:hover{color:var(--text)}
.stats-strip{display:flex;justify-content:center;gap:60px;flex-wrap:wrap;padding:40px;position:relative;z-index:1;border-top:1px solid rgba(28,40,64,.5);border-bottom:1px solid rgba(28,40,64,.5);background:rgba(12,17,32,.4)}
.stat-item{text-align:center}
.stat-num{font-family:'Orbitron',sans-serif;font-size:32px;font-weight:900;color:var(--bright);display:block}
.stat-label{font-size:10px;letter-spacing:3px;color:#4a6080;margin-top:4px}
footer{text-align:center;padding:28px 20px;position:relative;z-index:1;border-top:1px solid rgba(28,40,64,.4);font-size:11px;color:#253040;letter-spacing:1px;line-height:1.9}
footer em{color:#354050;font-style:normal}

/* ── Username modal ── */
#username-overlay{display:none;position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.88);backdrop-filter:blur(8px);align-items:center;justify-content:center}
#username-overlay.show{display:flex}
.username-modal{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:40px 36px;width:100%;max-width:400px;box-shadow:0 0 60px rgba(68,136,255,.08)}
.umod-title{font-family:'Orbitron',sans-serif;font-size:14px;letter-spacing:3px;color:var(--bright);margin-bottom:8px}
.umod-sub{font-size:11px;color:#4a6080;margin-bottom:28px;line-height:1.7}
.umod-input{width:100%;padding:12px 14px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:5px;color:var(--bright);font-family:'Share Tech Mono',monospace;font-size:14px;letter-spacing:1px;outline:none;transition:border-color .2s}
.umod-input:focus{border-color:var(--p1)}
.umod-status{font-size:10px;margin-top:5px;letter-spacing:1px;min-height:16px}
.umod-status.ok{color:var(--green)}.umod-status.err{color:var(--p2)}
.btn-umod-confirm{width:100%;padding:13px;margin-top:8px;cursor:pointer;background:rgba(34,221,119,.12);border:1px solid rgba(34,221,119,.5);color:var(--green);font-family:'Orbitron',sans-serif;font-size:11px;letter-spacing:2px;border-radius:5px;transition:all .15s}
.btn-umod-confirm:hover:not(:disabled){background:rgba(34,221,119,.24);box-shadow:0 0 16px rgba(34,221,119,.2)}
.btn-umod-confirm:disabled{opacity:.3;cursor:not-allowed}
@media(max-width:480px){nav{padding:12px 20px}.hero{padding:100px 20px 60px}.login-card{padding:24px 20px}.code-digit{width:38px;height:48px;font-size:18px}}
</style>
</head>
<body>

<nav>
  <a href="index.html" class="nav-logo">HOME<span>W</span>ORLDS Arean</a>
  <a href="lobby.html" id="btn-lobby" style="display:none" class="btn btn-primary">ENTER LOBBY →</a>
</nav>

<section class="hero">
  <div class="hero-pieces" id="hero-pieces"></div>
  <div class="hero-eyebrow">A GAME OF COSMIC STRATEGY</div>
  <h1 class="hero-title">HOME<span class="accent">W</span>ORLDS<br>Arean</h1>
  <p class="hero-subtitle">Two empires. Four colors. One universe.<br>Conquer the cosmos — or be consumed by it.</p>

  <div class="login-card" id="login-card">

    <!-- ── Main auth view ── -->
    <div id="auth-main">
      <div class="login-title">ENTER THE GALAXY</div>
      <div class="login-sub">Sign in to play online and track your rank</div>

      <button class="btn-google" id="btn-google">
        <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.875 2.684-6.615z"/><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332A8.997 8.997 0 0 0 9 18z"/><path fill="#FBBC05" d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z"/><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 6.29C4.672 4.163 6.656 3.58 9 3.58z"/></svg>
        CONTINUE WITH GOOGLE
      </button>

      <div class="login-divider">OR</div>

      <div class="auth-tabs">
        <button class="auth-tab active" id="tab-signin" onclick="switchTab('signin')">SIGN IN</button>
        <button class="auth-tab"        id="tab-signup" onclick="switchTab('signup')">CREATE ACCOUNT</button>
      </div>

      <!-- Sign-in form -->
      <div id="form-signin">
        <div class="auth-field">
          <label class="auth-label" for="si-email">EMAIL</label>
          <input class="auth-input" id="si-email" type="email" placeholder="pilot@galaxy.com" autocomplete="email">
        </div>
        <div class="auth-field">
          <label class="auth-label" for="si-password">PASSWORD</label>
          <input class="auth-input" id="si-password" type="password" placeholder="••••••••" autocomplete="current-password">
        </div>
        <button class="btn-auth" id="btn-signin">SIGN IN</button>
        <div class="auth-status" id="si-status"></div>
        <div class="auth-switch"><a onclick="showForgotPassword()">Forgot password?</a></div>
      </div>

      <!-- Sign-up form -->
      <div id="form-signup" style="display:none">
        <div class="auth-field">
          <label class="auth-label" for="su-email">EMAIL</label>
          <input class="auth-input" id="su-email" type="email" placeholder="pilot@galaxy.com" autocomplete="email">
        </div>
        <div class="auth-field">
          <label class="auth-label" for="su-pw1">PASSWORD</label>
          <input class="auth-input" id="su-pw1" type="password" placeholder="At least 8 characters" autocomplete="new-password" oninput="checkPwStrength()">
          <div class="pw-strength" id="pw-strength"></div>
        </div>
        <div class="auth-field">
          <label class="auth-label" for="su-pw2">CONFIRM PASSWORD</label>
          <input class="auth-input" id="su-pw2" type="password" placeholder="Repeat password" autocomplete="new-password" oninput="checkPwMatch()">
        </div>
        <div class="auth-check-row">
          <input type="checkbox" id="check-age">
          <label for="check-age">I am 13 years of age or older</label>
        </div>
        <div class="auth-check-row">
          <input type="checkbox" id="check-terms">
          <label for="check-terms">I agree to the <a href="terms.html" target="_blank">Terms of Service</a></label>
        </div>
        <button class="btn-auth" id="btn-signup">CREATE ACCOUNT</button>
        <div class="auth-status" id="su-status"></div>
        <div class="legal-note">We only email you a one-time verification code.<br>No newsletters. No spam.</div>
      </div>
    </div>

    <!-- ── Verify code panel ── -->
    <div id="verify-panel">
      <div class="login-title">VERIFY YOUR EMAIL</div>
      <div class="verify-email-hint">A 6-digit code was sent to<br><strong id="verify-email-display"></strong></div>
      <div class="code-input-row" id="code-inputs">
        <input class="code-digit" maxlength="1" inputmode="numeric" pattern="[0-9]">
        <input class="code-digit" maxlength="1" inputmode="numeric" pattern="[0-9]">
        <input class="code-digit" maxlength="1" inputmode="numeric" pattern="[0-9]">
        <input class="code-digit" maxlength="1" inputmode="numeric" pattern="[0-9]">
        <input class="code-digit" maxlength="1" inputmode="numeric" pattern="[0-9]">
        <input class="code-digit" maxlength="1" inputmode="numeric" pattern="[0-9]">
      </div>
      <button class="btn-auth" id="btn-verify">VERIFY</button>
      <div class="auth-status" id="verify-status"></div>
      <div class="resend-row">
        <button class="btn-resend" id="btn-resend" disabled>Resend code</button>
        <span class="resend-timer" id="resend-timer"></span>
      </div>
    </div>

    <!-- ── Forgot password panel ── -->
    <div id="forgot-panel" style="display:none">
      <div class="login-title">RESET PASSWORD</div>
      <div class="login-sub">Enter your email and we'll send a reset link</div>
      <div class="auth-field">
        <label class="auth-label" for="fp-email">EMAIL</label>
        <input class="auth-input" id="fp-email" type="email" placeholder="pilot@galaxy.com">
      </div>
      <button class="btn-auth" id="btn-fp-send">SEND RESET LINK</button>
      <div class="auth-status" id="fp-status"></div>
      <div class="auth-switch"><a onclick="showMain()">← Back to sign in</a></div>
    </div>

  </div><!-- /login-card -->

  <div id="hero-loggedin" style="display:none;text-align:center">
    <div style="font-size:13px;color:#4a6080;margin-bottom:24px;letter-spacing:1px">
      Welcome back, <span id="hero-name" style="color:var(--bright)"></span>
    </div>
    <a href="lobby.html" class="btn btn-primary btn-large">ENTER LOBBY →</a>
  </div>

</section>

<div class="stats-strip">
  <div class="stat-item"><span class="stat-num" id="stat-players">—</span><div class="stat-label">REGISTERED PILOTS</div></div>
  <div class="stat-item"><span class="stat-num" id="stat-games">—</span><div class="stat-label">GAMES PLAYED</div></div>
  <div class="stat-item"><span class="stat-num" id="stat-online">—</span><div class="stat-label">ONLINE NOW</div></div>
</div>

<section class="how-section">
  <div class="section-eyebrow">THE BASICS</div>
  <div class="section-title">FOUR COLORS. INFINITE STRATEGY.</div>
  <div class="powers-grid">
    <div class="power-card" style="--power-color:#ff3344;--power-bg:rgba(255,51,68,.1);--power-glow:rgba(255,51,68,.15)">
      <div class="power-icon"><img src="assets/ships/smallr_cb.webp" width="22" height="36" alt="red ship"></div>
      <div class="power-name">RED — HIJACK</div>
      <div class="power-desc">Capture enemy ships equal or smaller than your largest in the system.</div>
    </div>
    <div class="power-card" style="--power-color:#ffcc00;--power-bg:rgba(255,204,0,.1);--power-glow:rgba(255,204,0,.15)">
      <div class="power-icon"><img src="assets/ships/smally_cb.webp" width="22" height="36" alt="yellow ship"></div>
      <div class="power-name">YELLOW — MOVE</div>
      <div class="power-desc">Move ships between connected systems or discover new star systems.</div>
    </div>
    <div class="power-card" style="--power-color:#22dd77;--power-bg:rgba(34,221,119,.1);--power-glow:rgba(34,221,119,.15)">
      <div class="power-icon"><img src="assets/ships/smallg_cb.webp" width="22" height="36" alt="green ship"></div>
      <div class="power-name">GREEN — BUILD</div>
      <div class="power-desc">Construct new ships matching a color already present in your fleet.</div>
    </div>
    <div class="power-card" style="--power-color:#2266ff;--power-bg:rgba(34,102,255,.1);--power-glow:rgba(34,102,255,.15)">
      <div class="power-icon"><img src="assets/ships/smallb_cb.webp" width="22" height="36" alt="blue ship"></div>
      <div class="power-name">BLUE — TRADE</div>
      <div class="power-desc">Convert any ship to a different color, changing its available power.</div>
    </div>
  </div>
  <div class="attr-strip">
    Built in tribute to <a href="https://www.looneylabs.com/games/homeworlds" target="_blank" rel="noopener">Homeworlds</a>
    <br>Published by <a href="https://www.looneylabs.com" target="_blank" rel="noopener">Looney Labs</a>,<br>
    Game designed by <strong style="color:#4a7090">John Cooper</strong>,<br>System designed by <strong style="color:#4a7090">Andrew Looney</strong>.
    <br>This fan implementation is not affiliated with or endorsed by Looney Labs.
  </div>
</section>

<footer>HOMEWORLDS Arean &nbsp;|&nbsp; <em>May the pieces be with you.</em> &nbsp;|&nbsp; 2026</footer>

<div id="username-overlay">
  <div class="username-modal">
    <div class="umod-title">CHOOSE YOUR CALLSIGN</div>
    <div class="umod-sub">Pick a unique pilot name. This is how other players will see you.<br><strong style="color:#ffcc00">Your callsign is permanent and cannot be changed.</strong></div>
    <div style="margin-bottom:12px">
      <input class="umod-input" id="umod-input" maxlength="24" placeholder="Enter callsign..." autocomplete="off" spellcheck="false">
    </div>
    <div class="umod-status" id="umod-status"></div>
    <button class="btn-umod-confirm" id="umod-confirm" disabled>CONFIRM CALLSIGN</button>
  </div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
import {
  getAuth, GoogleAuthProvider, signInWithPopup,
  createUserWithEmailAndPassword, signInWithEmailAndPassword,
  sendPasswordResetEmail, onAuthStateChanged,
} from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
import { getDatabase, ref, get, set, onValue } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';
import { getFunctions, httpsCallable }          from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-functions.js';
import { firebaseConfig }                       from './firebase-config.js';

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getDatabase(app);
const fns  = getFunctions(app, 'us-central1');

const cfSendCode  = httpsCallable(fns, 'sendVerifCode');
const cfCheckCode = httpsCallable(fns, 'checkVerifCode');

let _pendingUser    = null;
let _resendInterval = null;
let _checkTimer     = null;

// ── Auth state ────────────────────────────────────────────────
onAuthStateChanged(auth, async user => {
  if (user) {
    const snap = await get(ref(db, `players/${user.uid}`));
    if (!snap.exists()) {
      // Email/password account that hasn't verified yet?
      if (user.providerData?.[0]?.providerId === 'password') {
        const vSnap = await get(ref(db, `emailVerif/${user.uid}`));
        if (!vSnap.val()?.used) {
          _pendingUser = user;
          showVerifyPanel(user.email);
          return;
        }
      }
      showUsernamePicker(user);
      return;
    }
    window.location.href = 'lobby.html';
  } else {
    showMain();
  }
});

// ── Panel helpers ─────────────────────────────────────────────
function showMain() {
  document.getElementById('auth-main').style.display    = 'block';
  document.getElementById('verify-panel').style.display = 'none';
  document.getElementById('forgot-panel').style.display = 'none';
  document.getElementById('login-card').style.display   = 'block';
  document.getElementById('hero-loggedin').style.display= 'none';
}
window.showMain = showMain;

window.showForgotPassword = () => {
  document.getElementById('auth-main').style.display    = 'none';
  document.getElementById('verify-panel').style.display = 'none';
  document.getElementById('forgot-panel').style.display = 'block';
  document.getElementById('fp-email').focus();
};

function showVerifyPanel(email) {
  document.getElementById('auth-main').style.display    = 'none';
  document.getElementById('verify-panel').style.display = 'block';
  document.getElementById('forgot-panel').style.display = 'none';
  document.getElementById('verify-email-display').textContent = email;
  document.querySelectorAll('.code-digit')[0]?.focus();
  startResendTimer(60);
}

// ── Tabs ──────────────────────────────────────────────────────
window.switchTab = (tab) => {
  const su = tab === 'signup';
  document.getElementById('form-signin').style.display = su ? 'none' : 'block';
  document.getElementById('form-signup').style.display = su ? 'block' : 'none';
  document.getElementById('tab-signin').classList.toggle('active', !su);
  document.getElementById('tab-signup').classList.toggle('active',  su);
  document.getElementById('si-status').textContent = '';
  document.getElementById('su-status').textContent = '';
};

// ── Password helpers ──────────────────────────────────────────
window.checkPwStrength = () => {
  const pw = document.getElementById('su-pw1').value;
  const bar = document.getElementById('pw-strength');
  if (!pw) { bar.className = 'pw-strength'; return; }
  const strong = pw.length >= 10 && /[A-Z]/.test(pw) && /[0-9]/.test(pw);
  bar.className = 'pw-strength ' + (strong ? 'strong' : pw.length >= 8 ? 'medium' : 'weak');
};
window.checkPwMatch = () => {
  const pw2 = document.getElementById('su-pw2');
  if (!pw2.value) { pw2.className = 'auth-input'; return; }
  pw2.className = 'auth-input ' + (pw2.value === document.getElementById('su-pw1').value ? 'ok' : 'err');
};

// ── Status helper ─────────────────────────────────────────────
function setStatus(id, msg, type = 'err') {
  const el = document.getElementById(id);
  el.textContent = msg;
  el.className = 'auth-status ' + type;
}

// ── Google ────────────────────────────────────────────────────
document.getElementById('btn-google').onclick = async () => {
  try {
    const p = new GoogleAuthProvider();
    p.setCustomParameters({ prompt: 'select_account' });
    await signInWithPopup(auth, p);
  } catch (e) { setStatus('si-status', friendlyError(e)); }
};

// ── Sign in ───────────────────────────────────────────────────
document.getElementById('btn-signin').onclick = async () => {
  const email = document.getElementById('si-email').value.trim();
  const pw    = document.getElementById('si-password').value;
  if (!email || !pw) { setStatus('si-status', 'Please fill in all fields'); return; }
  const btn = document.getElementById('btn-signin');
  btn.disabled = true; btn.textContent = '…';
  try {
    await signInWithEmailAndPassword(auth, email, pw);
  } catch (e) {
    setStatus('si-status', friendlyError(e));
    btn.disabled = false; btn.textContent = 'SIGN IN';
  }
};
document.getElementById('si-password').addEventListener('keydown', e => {
  if (e.key === 'Enter') document.getElementById('btn-signin').click();
});

// ── Sign up ───────────────────────────────────────────────────
document.getElementById('btn-signup').onclick = async () => {
  const email = document.getElementById('su-email').value.trim();
  const pw1   = document.getElementById('su-pw1').value;
  const pw2   = document.getElementById('su-pw2').value;
  if (!email)             { setStatus('su-status', 'Please enter your email');                     return; }
  if (pw1.length < 8)     { setStatus('su-status', 'Password must be at least 8 characters');      return; }
  if (pw1 !== pw2)         { setStatus('su-status', 'Passwords do not match');                     return; }
  if (!document.getElementById('check-age').checked)   { setStatus('su-status', 'You must be 13 or older to create an account'); return; }
  if (!document.getElementById('check-terms').checked) { setStatus('su-status', 'Please accept the Terms of Service');          return; }

  const btn = document.getElementById('btn-signup');
  btn.disabled = true; btn.textContent = '…';
  setStatus('su-status', 'Creating account…', 'info');

  try {
    const cred = await createUserWithEmailAndPassword(auth, email, pw1);
    _pendingUser = cred.user;
    setStatus('su-status', 'Sending verification code…', 'info');
    await cfSendCode({ uid: cred.user.uid, email });
    showVerifyPanel(email);
  } catch (e) {
    setStatus('su-status', friendlyError(e));
    btn.disabled = false; btn.textContent = 'CREATE ACCOUNT';
  }
};

// ── 6-digit code input ────────────────────────────────────────
const codeDigits = Array.from(document.querySelectorAll('.code-digit'));

codeDigits.forEach((inp, i) => {
  inp.addEventListener('keydown', e => {
    if (e.key === 'Backspace') { if (!inp.value && i > 0) codeDigits[i-1].focus(); return; }
    if (e.key === 'ArrowLeft'  && i > 0) { e.preventDefault(); codeDigits[i-1].focus(); }
    if (e.key === 'ArrowRight' && i < 5) { e.preventDefault(); codeDigits[i+1].focus(); }
  });
  inp.addEventListener('input', () => {
    inp.value = inp.value.replace(/\D/g, '').slice(-1);
    inp.classList.toggle('filled', !!inp.value);
    if (inp.value && i < 5) codeDigits[i+1].focus();
    if (codeDigits.every(d => d.value)) submitCode();
  });
  inp.addEventListener('paste', e => {
    e.preventDefault();
    const digits = (e.clipboardData.getData('text') || '').replace(/\D/g, '').slice(0, 6);
    digits.split('').forEach((ch, idx) => {
      if (codeDigits[idx]) { codeDigits[idx].value = ch; codeDigits[idx].classList.add('filled'); }
    });
    codeDigits[Math.min(digits.length, 5)].focus();
    if (digits.length === 6) submitCode();
  });
});

async function submitCode() {
  if (!_pendingUser) return;
  const code = codeDigits.map(d => d.value).join('');
  if (code.length < 6) return;
  const btn = document.getElementById('btn-verify');
  btn.disabled = true; btn.textContent = '…';
  try {
    await cfCheckCode({ uid: _pendingUser.uid, code });
    setStatus('verify-status', '✓ Verified!', 'ok');
    setTimeout(() => showUsernamePicker(_pendingUser), 500);
  } catch (e) {
    const msg = e.message || '';
    const display = msg.includes('WRONG_CODE') ? msg.split('WRONG_CODE: ')[1]
      : msg.includes('EXPIRED')  ? 'Code expired — request a new one'
      : msg.includes('LOCKED')   ? 'Too many attempts — please request a new code'
      : friendlyError(e);
    setStatus('verify-status', display);
    // Shake + clear
    const row = document.getElementById('code-inputs');
    row.classList.remove('shake');
    void row.offsetWidth;
    row.classList.add('shake');
    codeDigits.forEach(d => { d.value = ''; d.classList.remove('filled'); });
    codeDigits[0].focus();
    btn.disabled = false; btn.textContent = 'VERIFY';
  }
}
document.getElementById('btn-verify').onclick = submitCode;

// ── Resend timer ──────────────────────────────────────────────
function startResendTimer(secs) {
  const btn = document.getElementById('btn-resend');
  const lbl = document.getElementById('resend-timer');
  btn.disabled = true;
  clearInterval(_resendInterval);
  let left = secs;
  lbl.textContent = `(${left}s)`;
  _resendInterval = setInterval(() => {
    left--;
    if (left <= 0) { clearInterval(_resendInterval); btn.disabled = false; lbl.textContent = ''; }
    else lbl.textContent = `(${left}s)`;
  }, 1000);
}
document.getElementById('btn-resend').onclick = async () => {
  if (!_pendingUser) return;
  document.getElementById('btn-resend').disabled = true;
  setStatus('verify-status', 'Sending new code…', 'info');
  try {
    await cfSendCode({ uid: _pendingUser.uid, email: _pendingUser.email });
    setStatus('verify-status', 'New code sent!', 'ok');
    codeDigits.forEach(d => { d.value = ''; d.classList.remove('filled'); });
    codeDigits[0].focus();
    startResendTimer(60);
  } catch (e) {
    setStatus('verify-status', friendlyError(e));
    document.getElementById('btn-resend').disabled = false;
  }
};

// ── Forgot password ───────────────────────────────────────────
document.getElementById('btn-fp-send').onclick = async () => {
  const email = document.getElementById('fp-email').value.trim();
  if (!email) { setStatus('fp-status', 'Please enter your email'); return; }
  const btn = document.getElementById('btn-fp-send');
  btn.disabled = true; btn.textContent = '…';
  try {
    await sendPasswordResetEmail(auth, email);
    setStatus('fp-status', 'Reset link sent — check your inbox', 'ok');
    btn.textContent = '✓ SENT';
  } catch (e) {
    setStatus('fp-status', friendlyError(e));
    btn.disabled = false; btn.textContent = 'SEND RESET LINK';
  }
};

// ── Username picker ───────────────────────────────────────────
function showUsernamePicker(user) {
  _pendingUser = user;
  document.getElementById('login-card').style.display = 'none';
  document.getElementById('username-overlay').classList.add('show');
  document.getElementById('umod-input').focus();
}

const umodInput   = document.getElementById('umod-input');
const umodStatus  = document.getElementById('umod-status');
const umodConfirm = document.getElementById('umod-confirm');

umodInput.addEventListener('input', () => {
  const val = umodInput.value.trim();
  umodConfirm.disabled = true;
  umodStatus.className = 'umod-status';
  umodStatus.textContent = '';
  clearTimeout(_checkTimer);
  if (val.length < 2) { if (val.length) { umodStatus.textContent = 'Too short — minimum 2 characters'; umodStatus.className = 'umod-status err'; } return; }
  if (!/^[a-zA-Z0-9_\-]+$/.test(val)) { umodStatus.textContent = 'Letters, numbers, _ and - only'; umodStatus.className = 'umod-status err'; return; }
  umodStatus.textContent = 'Checking…';
  _checkTimer = setTimeout(async () => {
    const snap = await get(ref(db, `usernames/${val.toLowerCase()}`));
    if (snap.exists()) { umodStatus.textContent = '✗ Already taken'; umodStatus.className = 'umod-status err'; }
    else { umodStatus.textContent = '✓ Available!'; umodStatus.className = 'umod-status ok'; umodConfirm.disabled = false; }
  }, 500);
});

umodConfirm.onclick = async () => {
  const username = umodInput.value.trim();
  if (!_pendingUser || !username) return;
  umodConfirm.disabled = true; umodConfirm.textContent = 'SAVING…';
  try {
    const profile = {
      uid: _pendingUser.uid, name: username, elo: 1200, stars: 0,
      wins: 0, losses: 0, draws: 0, advancedMode: false,
      avatarUrl: _pendingUser.photoURL || '', avatarBase64: '',
      createdAt: Date.now(),
      authProvider: _pendingUser.providerData?.[0]?.providerId || 'unknown',
    };
    await set(ref(db, `players/${_pendingUser.uid}`), profile);
    await set(ref(db, `usernames/${username.toLowerCase()}`), _pendingUser.uid);
    document.getElementById('username-overlay').classList.remove('show');
    window.location.href = 'lobby.html';
  } catch (e) {
    umodStatus.textContent = e.message; umodStatus.className = 'umod-status err';
    umodConfirm.disabled = false; umodConfirm.textContent = 'CONFIRM CALLSIGN';
  }
};

// ── Friendly errors ───────────────────────────────────────────
function friendlyError(e) {
  const c = e?.code || e?.message || '';
  if (c.includes('email-already-in-use'))  return 'An account with this email already exists';
  if (c.includes('wrong-password') || c.includes('invalid-credential')) return 'Incorrect email or password';
  if (c.includes('user-not-found'))        return 'No account found with this email';
  if (c.includes('invalid-email'))         return 'Please enter a valid email address';
  if (c.includes('too-many-requests'))     return 'Too many attempts — please try again later';
  if (c.includes('network-request-failed'))return 'Network error — check your connection';
  if (c.includes('RATE_LIMITED'))          return 'Please wait 60 seconds before requesting a new code';
  return e?.message || 'Something went wrong. Please try again.';
}

// ── Live stats ────────────────────────────────────────────────
onValue(ref(db, 'stats'), snap => {
  const s = snap.val() || {};
  document.getElementById('stat-players').textContent = s.players ?? '0';
  document.getElementById('stat-games').textContent   = s.games   ?? '0';
  document.getElementById('stat-online').textContent  = s.online  ?? '0';
});

// ── Floating pieces ───────────────────────────────────────────
const COLORS = ['#ff3344','#ffcc00','#22dd77','#2266ff'];
const container = document.getElementById('hero-pieces');
for (let i = 0; i < 16; i++) {
  const el = document.createElement('div');
  const col = COLORS[i%4], sz = Math.random()*30+14;
  el.className = 'piece-float';
  el.style.cssText = `left:${Math.random()*100}%;top:${Math.random()*100}%;width:${sz}px;height:${sz}px;border:2px solid ${col};border-radius:${Math.random()>.5?'50%':'4px'};animation-duration:${Math.random()*20+15}s;animation-delay:${Math.random()*-20}s`;
  container.appendChild(el);
}
</script>
</body>
</html>
