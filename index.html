<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Homeworlds Duel</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#060912; --panel:#0c1120; --border:#1c2840;
  --text:#a8c0e0; --bright:#ddeeff;
  --red:#ff3344; --blue:#2266ff; --yellow:#ffcc00; --green:#22dd77;
  --p1:#4488ff; --p2:#ff4455;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{min-height:100%;background:var(--bg);color:var(--text);font-family:'Share Tech Mono',monospace;overflow-x:hidden}

body::before{
  content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background-image:
    radial-gradient(circle at 10% 15%,rgba(255,255,255,.6) 1px,transparent 1px),
    radial-gradient(circle at 30% 70%,rgba(255,255,255,.4) 1px,transparent 1px),
    radial-gradient(circle at 55% 8%, rgba(255,255,255,.5) 1px,transparent 1px),
    radial-gradient(circle at 75% 85%,rgba(255,255,255,.6) 1px,transparent 1px),
    radial-gradient(circle at 90% 30%,rgba(255,255,255,.4) 1px,transparent 1px),
    radial-gradient(circle at 42% 45%,rgba(255,255,255,.3) 1px,transparent 1px),
    radial-gradient(circle at 18% 88%,rgba(255,255,255,.5) 1px,transparent 1px),
    radial-gradient(circle at 65% 55%,rgba(255,255,255,.4) 1px,transparent 1px),
    radial-gradient(circle at 85% 65%,rgba(255,255,255,.3) 1px,transparent 1px),
    radial-gradient(circle at 5%  50%,rgba(255,255,255,.5) 1px,transparent 1px),
    radial-gradient(circle at 50% 90%,rgba(255,255,255,.4) 1px,transparent 1px),
    radial-gradient(circle at 22% 35%,rgba(255,255,255,.3) 1px,transparent 1px),
    radial-gradient(circle at 70% 20%,rgba(255,255,255,.5) 1px,transparent 1px),
    radial-gradient(circle at 38% 62%,rgba(255,255,255,.4) 1px,transparent 1px),
    radial-gradient(circle at 92% 48%,rgba(255,255,255,.6) 1px,transparent 1px);
  background-size:900px 900px;
}

/* ── Nav ── */
nav{
  position:fixed;top:0;left:0;right:0;z-index:100;
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 40px;
  background:rgba(6,9,18,.88);backdrop-filter:blur(12px);
  border-bottom:1px solid rgba(28,40,64,.5);
}
.nav-logo{font-family:'Orbitron',sans-serif;font-weight:900;font-size:16px;letter-spacing:4px;color:var(--bright)}
.nav-logo span{color:var(--p1)}
.nav-btns{display:flex;gap:12px;align-items:center}
.btn{padding:9px 22px;border-radius:4px;cursor:pointer;font-family:'Orbitron',sans-serif;font-size:12px;letter-spacing:2px;transition:all .2s;text-decoration:none;display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:rgba(255,255,255,.03);color:var(--text)}
.btn:hover{background:rgba(255,255,255,.08);border-color:#3a5080;color:var(--bright)}
.btn-primary{background:rgba(68,136,255,.15);border-color:var(--p1);color:var(--p1)}
.btn-primary:hover{background:rgba(68,136,255,.3);box-shadow:0 0 20px rgba(68,136,255,.4)}
.btn-large{padding:15px 44px;font-size:14px;letter-spacing:3px}
.nav-user{display:flex;align-items:center;gap:12px}
.nav-avatar{width:30px;height:30px;border-radius:50%;background:rgba(68,136,255,.2);border:1px solid var(--p1);display:flex;align-items:center;justify-content:center;font-family:'Orbitron',sans-serif;font-size:12px;font-weight:700;color:var(--p1);overflow:hidden}
.nav-avatar img{width:100%;height:100%;object-fit:cover}
.nav-name{font-size:12px;color:var(--bright);letter-spacing:1px}

/* ── Hero ── */
.hero{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:120px 40px 80px;position:relative;z-index:1;text-align:center}
.hero-eyebrow{font-size:12px;letter-spacing:6px;color:#4a6080;margin-bottom:24px;text-transform:uppercase}
.hero-title{font-family:'Orbitron',sans-serif;font-weight:900;font-size:clamp(42px,8vw,96px);letter-spacing:6px;color:var(--bright);line-height:1;margin-bottom:12px}
.hero-title .accent{color:var(--p1)}
.hero-subtitle{font-size:14px;color:#506080;letter-spacing:2px;margin-bottom:60px;line-height:1.8}
.hero-pieces{position:absolute;inset:0;pointer-events:none;overflow:hidden}
.piece-float{position:absolute;opacity:.12;animation:floatPiece linear infinite}
@keyframes floatPiece{0%{transform:translateY(0) rotate(0deg);opacity:0}10%{opacity:.12}90%{opacity:.12}100%{transform:translateY(-120px) rotate(20deg);opacity:0}}

/* ── Login card ── */
.login-card{background:rgba(12,17,32,.92);border:1px solid var(--border);border-radius:12px;padding:36px;width:100%;max-width:380px;backdrop-filter:blur(20px);box-shadow:0 0 60px rgba(68,136,255,.06)}
.login-title{font-family:'Orbitron',sans-serif;font-size:14px;letter-spacing:3px;color:var(--bright);margin-bottom:8px;text-align:center}
.login-sub{font-size:12px;color:#4a6080;text-align:center;margin-bottom:28px}
.btn-google{width:100%;padding:14px 20px;background:rgba(255,255,255,.05);border:1px solid #3a5080;color:var(--bright);font-family:'Orbitron',sans-serif;font-size:12px;letter-spacing:2px;border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:12px;transition:all .2s;margin-bottom:12px}
.btn-google:hover{background:rgba(255,255,255,.1);border-color:var(--bright)}
.btn-discord{width:100%;padding:14px 20px;background:rgba(88,101,242,.1);border:1px solid rgba(88,101,242,.4);color:#8892f8;font-family:'Orbitron',sans-serif;font-size:12px;letter-spacing:2px;border-radius:4px;cursor:not-allowed;display:flex;align-items:center;justify-content:center;gap:12px;opacity:.5}
.login-divider{display:flex;align-items:center;gap:12px;margin:14px 0;font-size:12px;color:#2a3850;letter-spacing:2px}
.login-divider::before,.login-divider::after{content:'';flex:1;height:1px;background:var(--border)}
.login-note{font-size:12px;color:#2a3850;text-align:center;margin-top:14px;line-height:1.6}

/* ── How to play ── */
.how-section{max-width:920px;margin:0 auto;padding:80px 40px;position:relative;z-index:1}
.section-eyebrow{font-size:12px;letter-spacing:5px;color:#4a6080;margin-bottom:16px;text-transform:uppercase}
.section-title{font-family:'Orbitron',sans-serif;font-size:24px;font-weight:700;color:var(--bright);margin-bottom:48px;letter-spacing:2px}
.powers-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:48px}
.power-card{background:rgba(12,17,32,.85);border:1px solid var(--border);border-radius:8px;padding:20px 16px;text-align:center;transition:border-color .2s,box-shadow .2s}
.power-card:hover{border-color:var(--power-color,#3a5080);box-shadow:0 0 16px var(--power-glow,transparent)}
/* Circle container for the ship image */
.power-icon{
  width:48px;height:48px;border-radius:50%;margin:0 auto 12px;
  background:var(--power-bg,rgba(255,255,255,.05));
  border:1px solid var(--power-color,#3a5080);
  display:flex;align-items:center;justify-content:center;
  overflow:hidden;
}
.power-icon img{display:block;image-rendering:auto}
.power-name{font-family:'Orbitron',sans-serif;font-size:12px;letter-spacing:2px;color:var(--power-color,var(--text));margin-bottom:6px}
.power-desc{font-size:12px;color:#4a6080;line-height:1.6}

/* ── Attribution strip ── */
.attr-strip{
  max-width:720px;margin:0 auto 80px;padding:0 40px;
  position:relative;z-index:1;text-align:center;
  font-size:12px;color:#3a5060;letter-spacing:1px;line-height:2;
}
.attr-strip a{color:#4a7090;text-decoration:none}
.attr-strip a:hover{color:var(--text)}

/* ── Stats strip ── */
.stats-strip{display:flex;justify-content:center;gap:60px;flex-wrap:wrap;padding:40px;position:relative;z-index:1;border-top:1px solid rgba(28,40,64,.5);border-bottom:1px solid rgba(28,40,64,.5);background:rgba(12,17,32,.4)}
.stat-item{text-align:center}
.stat-num{font-family:'Orbitron',sans-serif;font-size:32px;font-weight:900;color:var(--bright);display:block}
.stat-label{font-size:12px;letter-spacing:3px;color:#4a6080;margin-top:4px}

/* ── Footer ── */
footer{text-align:center;padding:28px 20px;position:relative;z-index:1;border-top:1px solid rgba(28,40,64,.4);font-size:12px;color:#253040;letter-spacing:1px;line-height:1.9}
footer em{color:#354050;font-style:normal}

/* ── Username picker modal ── */
#username-overlay{
  display:none;position:fixed;inset:0;z-index:200;
  background:rgba(0,0,0,.88);backdrop-filter:blur(8px);
  align-items:center;justify-content:center;
}
#username-overlay.show{display:flex}
.username-modal{
  background:var(--panel);border:1px solid var(--border);
  border-radius:12px;padding:40px 36px;width:100%;max-width:400px;
  box-shadow:0 0 60px rgba(68,136,255,.08);
}
.umod-title{font-family:'Orbitron',sans-serif;font-size:14px;letter-spacing:3px;color:var(--bright);margin-bottom:8px}
.umod-sub{font-size:12px;color:#4a6080;margin-bottom:28px;line-height:1.7}
.umod-row{position:relative;margin-bottom:12px}
.umod-input{
  width:100%;padding:12px 14px;
  background:rgba(255,255,255,.04);border:1px solid var(--border);
  border-radius:5px;color:var(--bright);font-family:'Share Tech Mono',monospace;
  font-size:14px;letter-spacing:1px;outline:none;transition:border-color .2s;
}
.umod-input:focus{border-color:var(--p1)}
.umod-status{font-size:12px;margin-top:5px;letter-spacing:1px;min-height:16px}
.umod-status.ok {color:var(--green)}
.umod-status.err{color:var(--p2)}
.btn-umod-confirm{
  width:100%;padding:14px;margin-top:6px;cursor:pointer;
  background:rgba(34,221,119,.12);border:1px solid rgba(34,221,119,.5);
  color:var(--green);font-family:'Orbitron',sans-serif;
  font-size:12px;letter-spacing:2px;border-radius:5px;transition:all .15s;
}
.btn-umod-confirm:hover:not(:disabled){background:rgba(34,221,119,.24);box-shadow:0 0 16px rgba(34,221,119,.2)}
.btn-umod-confirm:disabled{opacity:.3;cursor:not-allowed}
</style>
</head>
<body>

<!-- NAV -->
<nav>
  <div class="nav-logo">HOME<span>W</span>ORLDS DUEL</div>
  <div class="nav-btns" id="nav-btns">
    <a href="lobby.html" class="btn btn-primary" id="btn-lobby" style="display:none">ENTER LOBBY</a>
    <div class="nav-user" id="nav-user" style="display:none">
      <div class="nav-avatar" id="nav-avatar"></div>
      <span class="nav-name"  id="nav-name"></span>
      <button class="btn" id="btn-signout" style="padding:6px 14px;font-size:12px">SIGN OUT</button>
    </div>
  </div>
</nav>

<!-- HERO -->
<section class="hero">
  <div class="hero-pieces" id="hero-pieces"></div>
  <div class="hero-eyebrow">A GAME OF COSMIC STRATEGY</div>
  <h1 class="hero-title">HOME<span class="accent">W</span>ORLDS<br>DUEL</h1>
  <p class="hero-subtitle">Two empires. Four colors. One universe.<br>Conquer the cosmos — or be consumed by it.</p>

  <!-- Login card (hidden when logged in) -->
  <div class="login-card" id="login-card">
    <div class="login-title">ENTER THE GALAXY</div>
    <div class="login-sub">Sign in to play online, track your rank, and challenge rivals</div>
    <button class="btn-google" id="btn-google">
      <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.875 2.684-6.615z"/><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332A8.997 8.997 0 0 0 9 18z"/><path fill="#FBBC05" d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z"/><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 6.29C4.672 4.163 6.656 3.58 9 3.58z"/></svg>
      CONTINUE WITH GOOGLE
    </button>
    <div class="login-divider">COMING SOON</div>
    <button class="btn-discord" disabled>
      <svg width="18" height="14" viewBox="0 0 18 14" fill="#5865f2"><path d="M15.245 1.178A14.62 14.62 0 0 0 11.618 0c-.16.292-.347.687-.476 1a13.52 13.52 0 0 0-4.284 0C6.729.687 6.537.292 6.375 0A14.586 14.586 0 0 0 2.745 1.181C.395 4.703-.242 8.14.076 11.527A14.753 14.753 0 0 0 4.574 14c.36-.494.682-1.02.958-1.573a9.573 9.573 0 0 1-1.508-.738c.126-.094.25-.192.369-.292a10.507 10.507 0 0 0 9.214 0c.12.1.243.198.37.292-.48.29-.984.539-1.51.74.276.552.597 1.078.957 1.571A14.704 14.704 0 0 0 17.924 11.527C18.297 7.587 17.277 4.183 15.245 1.178zM6.009 9.444c-.926 0-1.686-.869-1.686-1.937 0-1.067.742-1.938 1.686-1.938.943 0 1.703.872 1.686 1.938.001 1.068-.743 1.937-1.686 1.937zm6.231 0c-.926 0-1.686-.869-1.686-1.937 0-1.067.743-1.938 1.686-1.938.944 0 1.703.872 1.687 1.938 0 1.068-.743 1.937-1.687 1.937z"/></svg>
      DISCORD — COMING SOON
    </button>
    <div class="login-note">No email required with Google sign-in.</div>
  </div>

  <!-- Logged-in CTA -->
  <div id="hero-loggedin" style="display:none;text-align:center">
    <div style="font-size:14px;color:#4a6080;margin-bottom:24px;letter-spacing:1px">
      Welcome back, <span id="hero-name" style="color:var(--bright)"></span>
    </div>
    <a href="lobby.html" class="btn btn-primary btn-large">ENTER LOBBY →</a>
  </div>
</section>

<!-- STATS STRIP -->
<div class="stats-strip">
  <div class="stat-item"><span class="stat-num" id="stat-players">—</span><div class="stat-label">REGISTERED PILOTS</div></div>
  <div class="stat-item"><span class="stat-num" id="stat-games">—</span>  <div class="stat-label">GAMES PLAYED</div></div>
  <div class="stat-item"><span class="stat-num" id="stat-online">—</span> <div class="stat-label">ONLINE NOW</div></div>
</div>

<!-- HOW TO PLAY -->
<section class="how-section">
  <div class="section-eyebrow">THE BASICS</div>
  <div class="section-title">FOUR COLORS. INFINITE STRATEGY.</div>
  <div class="powers-grid">
    <!-- Red — ship image: assets/ships/smallr.webp -->
    <div class="power-card" style="--power-color:#ff3344;--power-bg:rgba(255,51,68,.1);--power-glow:rgba(255,51,68,.15)">
      <div class="power-icon">
        <img src="assets/ships/smallr.webp" width="22" height="36" alt="red ship">
      </div>
      <div class="power-name">RED — HIJACK</div>
      <div class="power-desc">Capture enemy ships equal or smaller than your largest in the system.</div>
    </div>
    <!-- Yellow -->
    <div class="power-card" style="--power-color:#ffcc00;--power-bg:rgba(255,204,0,.1);--power-glow:rgba(255,204,0,.15)">
      <div class="power-icon">
        <img src="assets/ships/smally.webp" width="22" height="36" alt="yellow ship">
      </div>
      <div class="power-name">YELLOW — MOVE</div>
      <div class="power-desc">Move ships between connected systems or discover new star systems.</div>
    </div>
    <!-- Green -->
    <div class="power-card" style="--power-color:#22dd77;--power-bg:rgba(34,221,119,.1);--power-glow:rgba(34,221,119,.15)">
      <div class="power-icon">
        <img src="assets/ships/smallg.webp" width="22" height="36" alt="green ship">
      </div>
      <div class="power-name">GREEN — BUILD</div>
      <div class="power-desc">Construct new ships matching a color already present in your fleet.</div>
    </div>
    <!-- Blue -->
    <div class="power-card" style="--power-color:#2266ff;--power-bg:rgba(34,102,255,.1);--power-glow:rgba(34,102,255,.15)">
      <div class="power-icon">
        <img src="assets/ships/smallb.webp" width="22" height="36" alt="blue ship">
      </div>
      <div class="power-name">BLUE — TRADE</div>
      <div class="power-desc">Convert any ship to a different color, changing its available power.</div>
    </div>
  </div>

  <!-- Attribution -->
  <div class="attr-strip">
    Built in tribute to <a href="https://www.looneylabs.com/games/homeworlds" target="_blank" rel="noopener">Homeworlds</a>
    published by <a href="https://www.looneylabs.com" target="_blank" rel="noopener">Looney Labs</a>,
    game designed by <strong style="color:#4a7090">Andrew Looney</strong>.
    This fan implementation is not affiliated with or endorsed by Looney Labs.
  </div>
</section>

<!-- FOOTER -->
<footer>
  HOMEWORLDS DUEL &nbsp;|&nbsp; <em>May the pieces be with you.</em> &nbsp;|&nbsp; 2026
</footer>

<!-- USERNAME PICK MODAL -->
<div id="username-overlay">
  <div class="username-modal">
    <div class="umod-title">CHOOSE YOUR CALLSIGN</div>
    <div class="umod-sub">
      Pick a unique pilot name. This is how other players will see you.<br>
      You can change it later in your profile.
    </div>
    <div class="umod-row">
      <input class="umod-input" id="umod-input" maxlength="24" placeholder="Enter callsign..." autocomplete="off" spellcheck="false">
    </div>
    <div class="umod-status" id="umod-status"></div>
    <button class="btn-umod-confirm" id="umod-confirm" disabled>CONFIRM CALLSIGN</button>
  </div>
</div>

<script type="module">
import { initializeApp }      from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
import { getAuth,GoogleAuthProvider,signInWithPopup,signOut,onAuthStateChanged }
                              from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
import { getDatabase,ref,get,set,onValue }
                              from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';
import { firebaseConfig }     from './firebase-config.js';

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getDatabase(app);

// ── Tier lookup (mirrored from auth.js so we don't need import) ──
const TIERS=[
  {name:'Iron',min:0,max:4,color:'#8a9bb0'},{name:'Bronze',min:5,max:9,color:'#cd7f32'},
  {name:'Silver',min:10,max:14,color:'#c0c0c0'},{name:'Gold',min:15,max:19,color:'#ffd700'},
  {name:'Platinum',min:20,max:24,color:'#00d4ff'},{name:'Emerald',min:25,max:29,color:'#22dd77'},
  {name:'Diamond',min:30,max:34,color:'#b9f2ff'},{name:'Master',min:35,max:39,color:'#9b59b6'},
  {name:'Grandmaster',min:40,max:44,color:'#ff6b35'},{name:'Star Captain',min:45,max:Infinity,color:'#ffcc00'},
];
function getTier(s=0){return TIERS.find(t=>s>=t.min&&s<=t.max)||TIERS[0]}

// ── Auth state ───────────────────────────────────────────────
onAuthStateChanged(auth, async user => {
  if (user) {
    const snap = await get(ref(db, `players/${user.uid}`));
    if (!snap.exists()) {
      // New player — show username picker
      showUsernamePicker(user);
      return;
    }
    const p = snap.val();
    showLoggedIn(user, p);
  } else {
    showLoggedOut();
  }
});

function showLoggedIn(user, p) {
  document.getElementById('login-card').style.display    = 'none';
  document.getElementById('hero-loggedin').style.display = 'block';
  document.getElementById('nav-user').style.display      = 'flex';
  document.getElementById('btn-lobby').style.display     = 'inline-flex';
  document.getElementById('hero-name').textContent       = p.name;
  document.getElementById('nav-name').textContent        = p.name;
  const av = document.getElementById('nav-avatar');
  const avatar = p.avatarBase64 || p.avatarUrl || '';
  if (avatar) av.innerHTML = `<img src="${avatar}" alt="">`;
  else av.textContent = p.name[0].toUpperCase();
}

function showLoggedOut() {
  document.getElementById('login-card').style.display    = 'block';
  document.getElementById('hero-loggedin').style.display = 'none';
  document.getElementById('nav-user').style.display      = 'none';
  document.getElementById('btn-lobby').style.display     = 'none';
}

// ── Google sign-in ───────────────────────────────────────────
document.getElementById('btn-google').onclick = async () => {
  try {
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });
    await signInWithPopup(auth, provider);
    // onAuthStateChanged handles redirect / username modal
  } catch (e) { alert('Sign-in failed: ' + e.message); }
};

document.getElementById('btn-signout').onclick = async () => { await signOut(auth); };

// ── Username picker ──────────────────────────────────────────
let _pendingUser = null;
let _checkTimer  = null;

function showUsernamePicker(user) {
  _pendingUser = user;
  document.getElementById('login-card').style.display = 'none';
  document.getElementById('username-overlay').classList.add('show');
  document.getElementById('umod-input').focus();
}

const umodInput   = document.getElementById('umod-input');
const umodStatus  = document.getElementById('umod-status');
const umodConfirm = document.getElementById('umod-confirm');

umodInput.addEventListener('input', () => {
  const val = umodInput.value.trim();
  umodConfirm.disabled = true;
  umodStatus.className = 'umod-status';
  umodStatus.textContent = '';
  clearTimeout(_checkTimer);

  if (val.length < 2) {
    umodStatus.textContent = val.length ? 'Too short — minimum 2 characters' : '';
    umodStatus.className = 'umod-status err';
    return;
  }
  if (!/^[a-zA-Z0-9_\-]+$/.test(val)) {
    umodStatus.textContent = 'Letters, numbers, _ and - only';
    umodStatus.className = 'umod-status err';
    return;
  }

  umodStatus.textContent = 'Checking…';
  _checkTimer = setTimeout(async () => {
    const snap = await get(ref(db, `usernames/${val.toLowerCase()}`));
    if (snap.exists()) {
      umodStatus.textContent = '✗ Already taken';
      umodStatus.className = 'umod-status err';
      umodConfirm.disabled = true;
    } else {
      umodStatus.textContent = '✓ Available!';
      umodStatus.className = 'umod-status ok';
      umodConfirm.disabled = false;
    }
  }, 500);
});

umodConfirm.onclick = async () => {
  const username = umodInput.value.trim();
  if (!_pendingUser || !username) return;
  umodConfirm.disabled = true;
  umodConfirm.textContent = 'SAVING…';
  try {
    const profile = {
      uid: _pendingUser.uid, name: username, elo: 1200, stars: 0,
      wins: 0, losses: 0, advancedMode: false,
      avatarUrl: _pendingUser.photoURL || '', avatarBase64: '',
      createdAt: Date.now(),
    };
    await set(ref(db, `players/${_pendingUser.uid}`), profile);
    await set(ref(db, `usernames/${username.toLowerCase()}`), _pendingUser.uid);
    document.getElementById('username-overlay').classList.remove('show');
    window.location.href = 'lobby.html';
  } catch (e) {
    umodStatus.textContent = e.message;
    umodStatus.className = 'umod-status err';
    umodConfirm.disabled = false;
    umodConfirm.textContent = 'CONFIRM CALLSIGN';
  }
};

// ── Live stats ───────────────────────────────────────────────
onValue(ref(db, 'stats'), snap => {
  const s = snap.val() || {};
  document.getElementById('stat-players').textContent = s.players ?? '0';
  document.getElementById('stat-games').textContent   = s.games   ?? '0';
  document.getElementById('stat-online').textContent  = s.online  ?? '0';
});

// ── Floating pieces ──────────────────────────────────────────
const COLORS=['#ff3344','#ffcc00','#22dd77','#2266ff'];
const container = document.getElementById('hero-pieces');
for(let i=0;i<16;i++){
  const el=document.createElement('div');
  const col=COLORS[i%4];
  const sz=Math.random()*30+14;
  el.className='piece-float';
  el.style.cssText=`left:${Math.random()*100}%;top:${Math.random()*100}%;width:${sz}px;height:${sz}px;border:2px solid ${col};border-radius:${Math.random()>.5?'50%':'4px'};animation-duration:${Math.random()*20+15}s;animation-delay:${Math.random()*-20}s`;
  container.appendChild(el);
}
</script>
</body>
</html>
