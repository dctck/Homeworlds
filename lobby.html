<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Lobby ‚Äî Homeworlds</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #060912; --panel: #0c1120; --border: #1c2840;
  --text: #a8c0e0; --bright: #ddeeff;
  --red: #ff3344; --blue: #2266ff; --yellow: #ffcc00; --green: #22dd77;
  --p1: #4488ff; --p2: #ff4455;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; background: var(--bg); color: var(--text); font-family: 'Share Tech Mono', monospace; overflow: hidden; }

body::before {
  content: ''; position: fixed; inset: 0; pointer-events: none; z-index: 0;
  background-image:
    radial-gradient(circle at 15% 25%, rgba(255,255,255,0.5) 1px, transparent 1px),
    radial-gradient(circle at 40% 70%, rgba(255,255,255,0.3) 1px, transparent 1px),
    radial-gradient(circle at 70% 15%, rgba(255,255,255,0.4) 1px, transparent 1px),
    radial-gradient(circle at 85% 80%, rgba(255,255,255,0.5) 1px, transparent 1px),
    radial-gradient(circle at 55% 45%, rgba(255,255,255,0.3) 1px, transparent 1px),
    radial-gradient(circle at 25% 85%, rgba(255,255,255,0.4) 1px, transparent 1px),
    radial-gradient(circle at 90% 40%, rgba(255,255,255,0.3) 1px, transparent 1px),
    radial-gradient(circle at 10% 60%, rgba(255,255,255,0.5) 1px, transparent 1px);
  background-size: 800px 800px;
}

/* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
.app {
  display: grid;
  grid-template-rows: 48px 1fr;
  grid-template-columns: 320px 1fr;
  grid-template-areas:
    "header header"
    "sidebar main";
  height: 100vh; position: relative; z-index: 1;
}

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
header {
  grid-area: header;
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 24px;
  background: var(--panel); border-bottom: 1px solid var(--border);
}
.logo {
  font-family: 'Orbitron', sans-serif; font-weight: 900; font-size: 13px;
  letter-spacing: 4px; color: var(--bright);
}
.logo span { color: var(--p1); }
.header-right { display: flex; align-items: center; gap: 16px; }
.player-chip {
  display: flex; align-items: center; gap: 8px;
  padding: 4px 12px 4px 4px;
  background: rgba(255,255,255,0.03); border: 1px solid var(--border);
  border-radius: 20px;
}
.avatar {
  width: 28px; height: 28px; border-radius: 50%;
  background: rgba(68,136,255,0.2); border: 1px solid var(--p1);
  display: flex; align-items: center; justify-content: center;
  font-family: 'Orbitron', sans-serif; font-size: 10px; font-weight: 700;
  color: var(--p1); overflow: hidden; flex-shrink: 0;
}
.avatar img { width: 100%; height: 100%; object-fit: cover; }
.player-info { display: flex; flex-direction: column; gap: 1px; }
.player-name { font-size: 11px; color: var(--bright); letter-spacing: 1px; }
.player-elo  { font-size: 9px; color: #4a6080; letter-spacing: 1px; }
.nav-link {
  font-size: 10px; letter-spacing: 2px; color: #4a6080;
  text-decoration: none; transition: color 0.2s; font-family: 'Orbitron', sans-serif;
}
.nav-link:hover { color: var(--bright); }

/* ‚îÄ‚îÄ Sidebar: Create Room ‚îÄ‚îÄ */
#sidebar {
  grid-area: sidebar;
  background: var(--panel); border-right: 1px solid var(--border);
  display: flex; flex-direction: column; overflow-y: auto;
}
.sidebar-section {
  padding: 16px; border-bottom: 1px solid var(--border);
}
.sidebar-label {
  font-family: 'Orbitron', sans-serif; font-size: 9px;
  letter-spacing: 3px; color: #4a6080; margin-bottom: 14px;
  text-transform: uppercase;
}
.form-row { margin-bottom: 12px; }
.form-label { font-size: 10px; color: #506070; letter-spacing: 1px; margin-bottom: 5px; display: block; }
.form-input {
  width: 100%; padding: 8px 10px;
  background: rgba(255,255,255,0.03); border: 1px solid var(--border);
  border-radius: 4px; color: var(--bright); font-family: 'Share Tech Mono', monospace;
  font-size: 12px; outline: none; transition: border-color 0.2s;
}
.form-input:focus { border-color: #3a5080; }
.form-input::placeholder { color: #2a3850; }

/* Toggle switch */
.toggle-row {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 12px;
}
.toggle-label { font-size: 11px; color: var(--text); }
.toggle {
  position: relative; width: 40px; height: 22px;
  display: inline-block; cursor: pointer;
}
.toggle input { opacity: 0; width: 0; height: 0; }
.toggle-track {
  position: absolute; inset: 0; border-radius: 11px;
  background: rgba(255,255,255,0.06); border: 1px solid var(--border);
  transition: 0.2s;
}
.toggle input:checked + .toggle-track { background: rgba(68,136,255,0.3); border-color: var(--p1); }
.toggle-thumb {
  position: absolute; top: 3px; left: 3px;
  width: 14px; height: 14px; border-radius: 50%;
  background: #4a6080; transition: 0.2s;
}
.toggle input:checked ~ .toggle-thumb { background: var(--p1); transform: translateX(18px); }

/* Time control tabs */
.tc-tabs { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 8px; }
.tc-btn {
  flex: 1; min-width: 60px; padding: 6px 4px;
  background: rgba(255,255,255,0.02); border: 1px solid var(--border);
  border-radius: 3px; color: #4a6080;
  font-family: 'Share Tech Mono', monospace; font-size: 10px;
  cursor: pointer; transition: all 0.15s; text-align: center;
}
.tc-btn:hover { border-color: #3a5080; color: var(--text); }
.tc-btn.active { background: rgba(68,136,255,0.1); border-color: var(--p1); color: var(--p1); }

.tc-detail { font-size: 10px; color: #4a6080; margin-top: 4px; display: none; }
.tc-detail.show { display: block; }
.tc-detail input {
  width: 50px; padding: 3px 6px; background: rgba(255,255,255,0.04);
  border: 1px solid var(--border); border-radius: 3px;
  color: var(--bright); font-family: 'Share Tech Mono', monospace; font-size: 11px;
}

/* Password field (hidden unless private) */
#password-row { display: none; }

.btn-create {
  width: 100%; padding: 12px; cursor: pointer;
  background: rgba(34,221,119,0.1); border: 1px solid rgba(34,221,119,0.4);
  color: #22dd77; font-family: 'Orbitron', sans-serif;
  font-size: 11px; letter-spacing: 2px; border-radius: 4px;
  transition: all 0.15s; margin-top: 4px;
}
.btn-create:hover { background: rgba(34,221,119,0.2); box-shadow: 0 0 16px rgba(34,221,119,0.2); }
.btn-create:disabled { opacity: 0.3; cursor: not-allowed; }

/* Passplay section */
.btn-passplay {
  width: 100%; padding: 10px; cursor: pointer;
  background: rgba(255,255,255,0.03); border: 1px solid var(--border);
  color: #506070; font-family: 'Orbitron', sans-serif;
  font-size: 10px; letter-spacing: 2px; border-radius: 4px;
  transition: all 0.15s;
}
.btn-passplay:hover { border-color: #3a5080; color: var(--text); }

/* ‚îÄ‚îÄ Main: Room list ‚îÄ‚îÄ */
#main {
  grid-area: main; display: flex; flex-direction: column; overflow: hidden;
}
.main-header {
  padding: 14px 20px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  flex-shrink: 0;
}
.main-title {
  font-family: 'Orbitron', sans-serif; font-size: 10px;
  letter-spacing: 3px; color: #506080;
}
.live-dot {
  width: 6px; height: 6px; border-radius: 50%; background: #22dd77;
  animation: blink 1.4s ease-in-out infinite; display: inline-block; margin-right: 6px;
}
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

/* Filter tabs */
.filter-tabs { display: flex; gap: 8px; }
.filter-tab {
  padding: 4px 12px; border-radius: 3px; font-size: 10px; letter-spacing: 1px;
  cursor: pointer; border: 1px solid transparent; transition: all 0.15s;
  font-family: 'Share Tech Mono', monospace;
}
.filter-tab.active { background: rgba(255,255,255,0.06); border-color: var(--border); color: var(--bright); }
.filter-tab:not(.active) { color: #3a5060; }
.filter-tab:not(.active):hover { color: var(--text); }

/* Room list */
#room-list { flex: 1; overflow-y: auto; padding: 12px 16px; }
#room-list::-webkit-scrollbar { width: 4px; }
#room-list::-webkit-scrollbar-thumb { background: #1c2840; border-radius: 2px; }

.room-card {
  background: rgba(12,17,32,0.7); border: 1px solid var(--border);
  border-radius: 6px; padding: 14px 16px; margin-bottom: 10px;
  display: grid; grid-template-columns: 1fr auto;
  align-items: center; gap: 12px;
  transition: border-color 0.2s;
}
.room-card:hover { border-color: #2a4060; }
.room-name {
  font-family: 'Orbitron', sans-serif; font-size: 11px;
  letter-spacing: 1px; color: var(--bright); margin-bottom: 4px;
  display: flex; align-items: center; gap: 6px;
}
.room-private { font-size: 9px; color: #ff8844; letter-spacing: 1px; }
.room-meta { font-size: 10px; color: #4a6080; line-height: 1.8; }
.room-host { color: #6080a0; }
.room-elo  { color: #506070; }
.room-tc   { color: #405060; }
.room-actions { display: flex; gap: 8px; align-items: center; }
.btn-join {
  padding: 8px 16px; border-radius: 4px; cursor: pointer;
  font-family: 'Orbitron', sans-serif; font-size: 10px; letter-spacing: 1px;
  background: rgba(68,136,255,0.12); border: 1px solid var(--p1);
  color: var(--p1); transition: all 0.15s; white-space: nowrap;
}
.btn-join:hover { background: rgba(68,136,255,0.25); box-shadow: 0 0 12px rgba(68,136,255,0.3); }
.room-status {
  font-size: 9px; letter-spacing: 1px; padding: 3px 8px; border-radius: 2px;
}
.status-waiting { color: #22dd77; border: 1px solid rgba(34,221,119,0.3); background: rgba(34,221,119,0.06); }
.status-playing { color: #ffcc00; border: 1px solid rgba(255,204,0,0.3); background: rgba(255,204,0,0.06); }

.empty-state {
  text-align: center; padding: 60px 20px; color: #253040;
}
.empty-state-icon { font-size: 40px; margin-bottom: 16px; }
.empty-state-text { font-size: 12px; letter-spacing: 1px; line-height: 2; }

/* ‚îÄ‚îÄ Password modal ‚îÄ‚îÄ */
#modal-overlay {
  display: none; position: fixed; inset: 0; z-index: 200;
  background: rgba(0,0,0,0.8); backdrop-filter: blur(4px);
  align-items: center; justify-content: center;
}
#modal-overlay.show { display: flex; }
.modal {
  background: var(--panel); border: 1px solid var(--border);
  border-radius: 10px; padding: 32px; width: 320px;
}
.modal-title {
  font-family: 'Orbitron', sans-serif; font-size: 12px;
  letter-spacing: 2px; color: var(--bright); margin-bottom: 8px;
}
.modal-sub { font-size: 11px; color: #4a6080; margin-bottom: 20px; }
.modal-btns { display: flex; gap: 10px; margin-top: 20px; }
.btn-cancel {
  flex: 1; padding: 10px; cursor: pointer;
  background: transparent; border: 1px solid var(--border);
  color: #506070; font-family: 'Share Tech Mono', monospace;
  font-size: 11px; border-radius: 4px; transition: all 0.15s;
}
.btn-cancel:hover { border-color: #3a5080; color: var(--text); }
.btn-confirm {
  flex: 1; padding: 10px; cursor: pointer;
  background: rgba(68,136,255,0.12); border: 1px solid var(--p1);
  color: var(--p1); font-family: 'Orbitron', sans-serif;
  font-size: 10px; letter-spacing: 1px; border-radius: 4px; transition: all 0.15s;
}
.btn-confirm:hover { background: rgba(68,136,255,0.25); }
</style>
</head>
<body>
<div class="app">

  <!-- HEADER -->
  <header>
    <a href="index.html" class="logo">HOME<span>W</span>ORLDS</a>
    <div class="header-right">
      <div class="player-chip" id="player-chip">
        <div class="avatar" id="hdr-avatar"></div>
        <div class="player-info">
          <span class="player-name" id="hdr-name">‚Äî</span>
          <span class="player-elo"  id="hdr-elo">ELO ‚Äî</span>
        </div>
      </div>
      <a href="profile.html" class="nav-link">PROFILE</a>
      <a href="#" class="nav-link" id="btn-signout">SIGN OUT</a>
    </div>
  </header>

  <!-- SIDEBAR: CREATE ROOM -->
  <aside id="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-label">CREATE ROOM</div>

      <div class="form-row">
        <label class="form-label">ROOM NAME</label>
        <input class="form-input" id="room-name" placeholder="My Galaxy" maxlength="32">
      </div>

      <div class="toggle-row">
        <span class="toggle-label">PRIVATE ROOM</span>
        <label class="toggle">
          <input type="checkbox" id="toggle-private">
          <div class="toggle-track"></div>
          <div class="toggle-thumb"></div>
        </label>
      </div>

      <div class="form-row" id="password-row">
        <label class="form-label">PASSWORD</label>
        <input class="form-input" id="room-password" type="password" placeholder="Set a password" maxlength="24">
      </div>

      <div class="form-row">
        <label class="form-label">TIME CONTROL</label>
        <div class="tc-tabs">
          <button class="tc-btn active" data-tc="unlimited">‚àû FREE</button>
          <button class="tc-btn" data-tc="blitz">‚ö° BLITZ</button>
          <button class="tc-btn" data-tc="sudden">üîî SUDDEN</button>
          <button class="tc-btn" data-tc="turn">‚è± TURN</button>
        </div>
        <div class="tc-detail" id="tc-detail-sudden">
          Sudden death: <input type="number" id="tc-sudden-min" value="20" min="5" max="120"> min each
        </div>
        <div class="tc-detail" id="tc-detail-turn">
          Per turn: <input type="number" id="tc-turn-min" value="5" min="1" max="30"> min
        </div>
      </div>

      <button class="btn-create" id="btn-create">CREATE ROOM</button>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-label">QUICK PLAY</div>
      <button class="btn-passplay" onclick="window.location.href='game.html?mode=passplay'">
        PASS &amp; PLAY ‚Äî LOCAL TWO PLAYER
      </button>
    </div>
  </aside>

  <!-- MAIN: ROOM LIST -->
  <main id="main">
    <div class="main-header">
      <div class="main-title">
        <span class="live-dot"></span>OPEN ROOMS
      </div>
      <div class="filter-tabs">
        <div class="filter-tab active" data-filter="waiting">WAITING</div>
        <div class="filter-tab" data-filter="playing">IN PROGRESS</div>
      </div>
    </div>
    <div id="room-list">
      <div class="empty-state">
        <div class="empty-state-icon">üåå</div>
        <div class="empty-state-text">No open rooms yet.<br>Create one to challenge the galaxy.</div>
      </div>
    </div>
  </main>

</div>

<!-- PASSWORD MODAL (join private room) -->
<div id="modal-overlay">
  <div class="modal">
    <div class="modal-title">PRIVATE ROOM</div>
    <div class="modal-sub">Enter the password to join this room.</div>
    <input class="form-input" id="modal-password" type="password" placeholder="Password">
    <div class="modal-btns">
      <button class="btn-cancel" id="modal-cancel">CANCEL</button>
      <button class="btn-confirm" id="modal-confirm">JOIN</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp }       from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
import { getAuth, signOut,
         onAuthStateChanged }  from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
import { getDatabase, ref,
         get, set, push,
         onValue, update }     from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';
import { firebaseConfig }      from './firebase-config.js';

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getDatabase(app);

let ME = null;     // current player profile
let currentFilter = 'waiting';
let pendingJoinRoom = null;

// ‚îÄ‚îÄ Auth guard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
onAuthStateChanged(auth, async (user) => {
  if (!user) { window.location.href = 'index.html'; return; }
  const snap = await get(ref(db, `players/${user.uid}`));
  ME = snap.val() || { uid: user.uid, name: 'Pilot', elo: 1200 };

  // Header
  document.getElementById('hdr-name').textContent = ME.name;
  document.getElementById('hdr-elo').textContent  = `ELO ${ME.elo}`;
  const av = document.getElementById('hdr-avatar');
  if (user.photoURL) av.innerHTML = `<img src="${user.photoURL}" alt="">`;
  else av.textContent = ME.name[0].toUpperCase();

  // Default room name
  document.getElementById('room-name').value = `${ME.name}'s Room`;

  subscribeRooms();
});

document.getElementById('btn-signout').onclick = async (e) => {
  e.preventDefault();
  await signOut(auth);
  window.location.href = 'index.html';
};

// ‚îÄ‚îÄ Time control tabs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let selectedTc = 'unlimited';
document.querySelectorAll('.tc-btn').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.tc-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    selectedTc = btn.dataset.tc;
    document.querySelectorAll('.tc-detail').forEach(d => d.classList.remove('show'));
    if (selectedTc === 'sudden') document.getElementById('tc-detail-sudden').classList.add('show');
    if (selectedTc === 'turn')   document.getElementById('tc-detail-turn').classList.add('show');
  };
});

// ‚îÄ‚îÄ Private toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('toggle-private').onchange = function() {
  document.getElementById('password-row').style.display = this.checked ? 'block' : 'none';
};

// ‚îÄ‚îÄ Filter tabs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('.filter-tab').forEach(tab => {
  tab.onclick = () => {
    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    currentFilter = tab.dataset.filter;
    renderRooms(lastRoomsSnap);
  };
});

// ‚îÄ‚îÄ Create room ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('btn-create').onclick = async () => {
  if (!ME) return;
  const name     = document.getElementById('room-name').value.trim() || `${ME.name}'s Room`;
  const isPriv   = document.getElementById('toggle-private').checked;
  const password = isPriv ? document.getElementById('room-password').value.trim() : '';

  let timeMs = 0, tcTurnMs = 0;
  if (selectedTc === 'blitz')   timeMs = 10 * 60 * 1000;
  if (selectedTc === 'sudden')  timeMs = (parseInt(document.getElementById('tc-sudden-min').value) || 20) * 60 * 1000;
  if (selectedTc === 'turn') {
    tcTurnMs = (parseInt(document.getElementById('tc-turn-min').value) || 5) * 60 * 1000;
    timeMs   = tcTurnMs;
  }

  const roomRef  = push(ref(db, 'rooms'));
  const roomId   = roomRef.key;

  await set(roomRef, {
    id:          roomId,
    name,
    status:      'waiting',
    isPrivate:   isPriv,
    password:    password ? simpleHash(password) : '',
    hostUid:     ME.uid,
    guestUid:    null,
    settings: { tcMode: selectedTc, timeMs, tcTurnMs },
    player1:   { uid: ME.uid, name: ME.name, elo: ME.elo },
    player2:     null,
    currentTurn: 1,
    createdAt:   Date.now(),
  });

  // Navigate host into the game
  window.location.href = `game.html?room=${roomId}&player=1`;
};

// ‚îÄ‚îÄ Subscribe to rooms (live) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let lastRoomsSnap = {};
function subscribeRooms() {
  onValue(ref(db, 'rooms'), snap => {
    lastRoomsSnap = snap.val() || {};
    renderRooms(lastRoomsSnap);
  });
}

function renderRooms(rooms) {
  const list = document.getElementById('room-list');
  const entries = Object.values(rooms)
    .filter(r => r.status === currentFilter)
    .sort((a, b) => b.createdAt - a.createdAt);

  if (entries.length === 0) {
    list.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">${currentFilter === 'waiting' ? 'üåå' : '‚öîÔ∏è'}</div>
        <div class="empty-state-text">
          ${currentFilter === 'waiting' ? 'No open rooms yet.<br>Create one to challenge the galaxy.' : 'No games currently in progress.'}
        </div>
      </div>`;
    return;
  }

  list.innerHTML = '';
  entries.forEach(room => {
    const card    = document.createElement('div');
    card.className = 'room-card';
    const isMyRoom = room.hostUid === ME?.uid;
    const tc = formatTc(room.settings);

    card.innerHTML = `
      <div>
        <div class="room-name">
          ${escHtml(room.name)}
          ${room.isPrivate ? '<span class="room-private">üîí PRIVATE</span>' : ''}
        </div>
        <div class="room-meta">
          <span class="room-host">HOST: ${escHtml(room.player1?.name || '‚Äî')}</span>
          &nbsp;¬∑&nbsp;
          <span class="room-elo">ELO ${room.player1?.elo ?? '‚Äî'}</span>
          &nbsp;¬∑&nbsp;
          <span class="room-tc">${tc}</span>
        </div>
      </div>
      <div class="room-actions">
        <span class="room-status ${room.status === 'waiting' ? 'status-waiting' : 'status-playing'}">
          ${room.status === 'waiting' ? 'OPEN' : 'IN PROGRESS'}
        </span>
        ${room.status === 'waiting' && !isMyRoom
          ? `<button class="btn-join" data-id="${room.id}" data-priv="${room.isPrivate}" data-hash="${room.password || ''}">JOIN</button>`
          : ''}
        ${isMyRoom && room.status === 'waiting'
          ? `<button class="btn-join" style="border-color:#22dd77;color:#22dd77" onclick="rejoinRoom('${room.id}')">REJOIN</button>`
          : ''}
      </div>`;
    list.appendChild(card);
  });

  // Attach join handlers
  list.querySelectorAll('.btn-join[data-id]').forEach(btn => {
    btn.onclick = () => handleJoin(btn.dataset.id, btn.dataset.priv === 'true', btn.dataset.hash);
  });
}

function rejoinRoom(roomId) {
  window.location.href = `game.html?room=${roomId}&player=1`;
}

// ‚îÄ‚îÄ Join room ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function handleJoin(roomId, isPrivate, storedHash) {
  if (isPrivate) {
    pendingJoinRoom = { roomId, storedHash };
    document.getElementById('modal-password').value = '';
    document.getElementById('modal-overlay').classList.add('show');
    return;
  }
  await joinRoom(roomId);
}

document.getElementById('modal-cancel').onclick = () => {
  document.getElementById('modal-overlay').classList.remove('show');
  pendingJoinRoom = null;
};

document.getElementById('modal-confirm').onclick = async () => {
  const pw   = document.getElementById('modal-password').value.trim();
  const hash = simpleHash(pw);
  if (hash !== pendingJoinRoom.storedHash) {
    alert('Incorrect password.');
    return;
  }
  document.getElementById('modal-overlay').classList.remove('show');
  await joinRoom(pendingJoinRoom.roomId);
  pendingJoinRoom = null;
};

async function joinRoom(roomId) {
  await update(ref(db, `rooms/${roomId}`), {
    guestUid: ME.uid,
    status:   'playing',
    player2:  { uid: ME.uid, name: ME.name, elo: ME.elo },
  });
  window.location.href = `game.html?room=${roomId}&player=2`;
}

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function formatTc(s) {
  if (!s || s.tcMode === 'unlimited') return '‚àû FREE';
  if (s.tcMode === 'blitz')           return '‚ö° 10 MIN';
  if (s.tcMode === 'sudden')          return `üîî ${Math.round(s.timeMs/60000)} MIN`;
  if (s.tcMode === 'turn')            return `‚è± ${Math.round(s.tcTurnMs/60000)} MIN/TURN`;
  return s.tcMode;
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// Simple client-side hash for private room passwords
// (not cryptographically secure, good enough for casual privacy)
function simpleHash(str) {
  let h = 0x811c9dc5;
  for (let i = 0; i < str.length; i++) {
    h ^= str.charCodeAt(i);
    h = (h * 0x01000193) >>> 0;
  }
  return h.toString(16);
}
</script>
</body>
</html>
