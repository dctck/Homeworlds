<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Profile — Homeworlds</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #060912; --panel: #0c1120; --border: #1c2840;
  --text: #a8c0e0; --bright: #ddeeff;
  --p1: #4488ff; --p2: #ff4455; --green: #22dd77;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { min-height: 100%; background: var(--bg); color: var(--text); font-family: 'Share Tech Mono', monospace; }

body::before {
  content: ''; position: fixed; inset: 0; pointer-events: none; z-index: 0;
  background-image:
    radial-gradient(circle at 20% 30%, rgba(255,255,255,0.5) 1px, transparent 1px),
    radial-gradient(circle at 60% 70%, rgba(255,255,255,0.3) 1px, transparent 1px),
    radial-gradient(circle at 80% 20%, rgba(255,255,255,0.4) 1px, transparent 1px),
    radial-gradient(circle at 40% 85%, rgba(255,255,255,0.5) 1px, transparent 1px),
    radial-gradient(circle at 90% 55%, rgba(255,255,255,0.3) 1px, transparent 1px);
  background-size: 800px 800px;
}

header {
  position: sticky; top: 0; z-index: 10;
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 32px; height: 48px;
  background: rgba(6,9,18,0.92); backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border);
}
.logo { font-family: 'Orbitron', sans-serif; font-weight: 900; font-size: 13px; letter-spacing: 4px; color: var(--bright); text-decoration: none; }
.logo span { color: var(--p1); }
.nav-links { display: flex; gap: 20px; }
.nav-link { font-size: 10px; letter-spacing: 2px; color: #4a6080; text-decoration: none; font-family: 'Orbitron', sans-serif; transition: color 0.2s; }
.nav-link:hover { color: var(--bright); }

.page { max-width: 780px; margin: 0 auto; padding: 48px 24px 80px; position: relative; z-index: 1; }

/* ── Profile card ── */
.profile-card {
  background: rgba(12,17,32,0.9); border: 1px solid var(--border);
  border-radius: 12px; padding: 32px; margin-bottom: 24px;
  display: flex; align-items: center; gap: 28px;
}
.big-avatar {
  width: 80px; height: 80px; border-radius: 50%; flex-shrink: 0;
  background: rgba(68,136,255,0.15); border: 2px solid var(--p1);
  display: flex; align-items: center; justify-content: center;
  font-family: 'Orbitron', sans-serif; font-size: 28px; font-weight: 900;
  color: var(--p1); overflow: hidden;
}
.big-avatar img { width: 100%; height: 100%; object-fit: cover; }
.profile-info { flex: 1; }
.profile-name-row { display: flex; align-items: center; gap: 12px; margin-bottom: 6px; }
.profile-display-name {
  font-family: 'Orbitron', sans-serif; font-size: 22px;
  font-weight: 700; color: var(--bright); letter-spacing: 2px;
}
.edit-icon {
  cursor: pointer; color: #3a5060; font-size: 14px; transition: color 0.2s;
  background: none; border: none; padding: 4px;
}
.edit-icon:hover { color: var(--bright); }
.profile-email { font-size: 11px; color: #3a5060; margin-bottom: 12px; }
.profile-elo-badge {
  display: inline-flex; align-items: center; gap: 8px;
  background: rgba(68,136,255,0.08); border: 1px solid rgba(68,136,255,0.3);
  border-radius: 4px; padding: 6px 14px;
}
.elo-label { font-size: 9px; letter-spacing: 3px; color: #4a6080; }
.elo-value { font-family: 'Orbitron', sans-serif; font-size: 18px; font-weight: 700; color: var(--p1); }

/* ── Stats grid ── */
.stats-grid {
  display: grid; grid-template-columns: repeat(3, 1fr);
  gap: 12px; margin-bottom: 24px;
}
.stat-card {
  background: rgba(12,17,32,0.8); border: 1px solid var(--border);
  border-radius: 8px; padding: 20px; text-align: center;
}
.stat-n {
  font-family: 'Orbitron', sans-serif; font-size: 28px; font-weight: 900;
  color: var(--bright); display: block; margin-bottom: 4px;
}
.stat-l { font-size: 10px; letter-spacing: 2px; color: #4a6080; }
.stat-card.wins .stat-n   { color: var(--green); }
.stat-card.losses .stat-n { color: var(--p2); }

/* ── Section ── */
.section {
  background: rgba(12,17,32,0.8); border: 1px solid var(--border);
  border-radius: 10px; padding: 24px; margin-bottom: 16px;
}
.section-title {
  font-family: 'Orbitron', sans-serif; font-size: 10px;
  letter-spacing: 3px; color: #4a6080; margin-bottom: 20px;
  padding-bottom: 10px; border-bottom: 1px solid rgba(28,40,64,0.6);
}

/* Settings rows */
.setting-row {
  display: flex; align-items: flex-start; justify-content: space-between;
  gap: 20px; padding: 14px 0;
  border-bottom: 1px solid rgba(28,40,64,0.4);
}
.setting-row:last-child { border-bottom: none; padding-bottom: 0; }
.setting-info { flex: 1; }
.setting-name { font-size: 12px; color: var(--bright); margin-bottom: 4px; }
.setting-desc { font-size: 11px; color: #4a6080; line-height: 1.6; }

/* Toggle */
.toggle { position: relative; width: 44px; height: 24px; display: inline-block; cursor: pointer; flex-shrink: 0; margin-top: 2px; }
.toggle input { opacity: 0; width: 0; height: 0; }
.toggle-track { position: absolute; inset: 0; border-radius: 12px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); transition: 0.2s; }
.toggle input:checked + .toggle-track { background: rgba(68,136,255,0.25); border-color: var(--p1); }
.toggle-thumb { position: absolute; top: 4px; left: 4px; width: 14px; height: 14px; border-radius: 50%; background: #4a6080; transition: 0.2s; }
.toggle input:checked ~ .toggle-thumb { background: var(--p1); transform: translateX(20px); }

/* Inline name edit */
.name-edit-row {
  display: none; align-items: center; gap: 8px; margin-top: 8px;
}
.name-edit-row.show { display: flex; }
.form-input {
  padding: 8px 12px; background: rgba(255,255,255,0.04);
  border: 1px solid #3a5080; border-radius: 4px;
  color: var(--bright); font-family: 'Share Tech Mono', monospace;
  font-size: 13px; outline: none; flex: 1; letter-spacing: 1px;
}
.form-input:focus { border-color: var(--p1); }
.btn-save {
  padding: 8px 18px; cursor: pointer;
  background: rgba(34,221,119,0.1); border: 1px solid var(--green);
  color: var(--green); font-family: 'Orbitron', sans-serif;
  font-size: 10px; letter-spacing: 1px; border-radius: 4px; transition: all 0.15s;
}
.btn-save:hover { background: rgba(34,221,119,0.2); }

/* Match history */
.match-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 0; border-bottom: 1px solid rgba(28,40,64,0.4);
  font-size: 11px;
}
.match-row:last-child { border-bottom: none; }
.match-result { font-family: 'Orbitron', sans-serif; font-size: 10px; letter-spacing: 1px; }
.match-result.win  { color: var(--green); }
.match-result.loss { color: var(--p2); }
.match-opp { color: var(--text); }
.match-elo { color: #4a6080; font-size: 10px; }
.match-date { color: #2a3850; font-size: 10px; }
.no-history { color: #253040; font-size: 11px; letter-spacing: 1px; text-align: center; padding: 20px; }

/* Danger zone */
.btn-danger {
  padding: 10px 20px; cursor: pointer;
  background: rgba(255,68,85,0.08); border: 1px solid rgba(255,68,85,0.3);
  color: var(--p2); font-family: 'Orbitron', sans-serif;
  font-size: 10px; letter-spacing: 1px; border-radius: 4px; transition: all 0.15s;
}
.btn-danger:hover { background: rgba(255,68,85,0.18); }
</style>
</head>
<body>

<header>
  <a href="index.html" class="logo">HOME<span>W</span>ORLDS</a>
  <div class="nav-links">
    <a href="lobby.html" class="nav-link">LOBBY</a>
    <a href="#" class="nav-link" id="btn-signout">SIGN OUT</a>
  </div>
</header>

<div class="page">

  <!-- PROFILE CARD -->
  <div class="profile-card">
    <div class="big-avatar" id="big-avatar"></div>
    <div class="profile-info">
      <div class="profile-name-row">
        <div class="profile-display-name" id="display-name">—</div>
        <button class="edit-icon" id="btn-edit-name" title="Edit name">✎</button>
      </div>
      <div class="name-edit-row" id="name-edit-row">
        <input class="form-input" id="name-input" maxlength="24" placeholder="Your callsign">
        <button class="btn-save" id="btn-save-name">SAVE</button>
        <button class="btn-save" id="btn-cancel-name" style="border-color:var(--border);color:#506070;background:transparent">✕</button>
      </div>
      <div class="profile-email" id="profile-email"></div>
      <div class="profile-elo-badge">
        <span class="elo-label">ELO</span>
        <span class="elo-value" id="elo-value">—</span>
      </div>
    </div>
  </div>

  <!-- STATS -->
  <div class="stats-grid">
    <div class="stat-card">
      <span class="stat-n" id="stat-total">—</span>
      <span class="stat-l">GAMES PLAYED</span>
    </div>
    <div class="stat-card wins">
      <span class="stat-n" id="stat-wins">—</span>
      <span class="stat-l">VICTORIES</span>
    </div>
    <div class="stat-card losses">
      <span class="stat-n" id="stat-losses">—</span>
      <span class="stat-l">DEFEATS</span>
    </div>
  </div>

  <!-- SETTINGS -->
  <div class="section">
    <div class="section-title">GAME SETTINGS</div>

    <div class="setting-row">
      <div class="setting-info">
        <div class="setting-name">ADVANCED MODE</div>
        <div class="setting-desc">
          Hides action buttons. Interact entirely by clicking colored stars and ships directly.
          Best for experienced players. Arrows still work in this mode.
        </div>
      </div>
      <label class="toggle">
        <input type="checkbox" id="toggle-advanced">
        <div class="toggle-track"></div>
        <div class="toggle-thumb"></div>
      </label>
    </div>

    <div class="setting-row">
      <div class="setting-info">
        <div class="setting-name">MY HOMEWORLD AT BOTTOM</div>
        <div class="setting-desc">
          Your homeworld always renders at the bottom of the board. Currently always on.
        </div>
      </div>
      <label class="toggle">
        <input type="checkbox" id="toggle-hwbottom" checked disabled>
        <div class="toggle-track"></div>
        <div class="toggle-thumb"></div>
      </label>
    </div>
  </div>

  <!-- MATCH HISTORY -->
  <div class="section">
    <div class="section-title">RECENT MATCHES</div>
    <div id="match-history">
      <div class="no-history">No matches recorded yet.</div>
    </div>
  </div>

  <!-- DANGER ZONE -->
  <div class="section">
    <div class="section-title">ACCOUNT</div>
    <div class="setting-row">
      <div class="setting-info">
        <div class="setting-name">SIGN OUT</div>
        <div class="setting-desc">Sign out from this device. Your data is saved.</div>
      </div>
      <button class="btn-danger" id="btn-signout2">SIGN OUT</button>
    </div>
  </div>

</div>

<script type="module">
import { initializeApp }       from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
import { getAuth, signOut,
         onAuthStateChanged }  from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
import { getDatabase, ref,
         get, update, onValue } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';
import { firebaseConfig }      from './firebase-config.js';

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getDatabase(app);

let ME   = null;
let USER = null;

// ── Auth guard ───────────────────────────────────────────────
onAuthStateChanged(auth, async (user) => {
  if (!user) { window.location.href = 'index.html'; return; }
  USER = user;
  await loadProfile(user);
});

async function loadProfile(user) {
  const snap = await get(ref(db, `players/${user.uid}`));
  ME = snap.val();
  if (!ME) { window.location.href = 'index.html'; return; }

  // Avatar
  const av = document.getElementById('big-avatar');
  if (user.photoURL) av.innerHTML = `<img src="${user.photoURL}" alt="">`;
  else av.textContent = ME.name[0].toUpperCase();

  // Name + email
  document.getElementById('display-name').textContent  = ME.name;
  document.getElementById('name-input').value          = ME.name;
  document.getElementById('profile-email').textContent = user.email || '';
  document.getElementById('elo-value').textContent     = ME.elo;

  // Stats
  const total = (ME.wins || 0) + (ME.losses || 0);
  document.getElementById('stat-total').textContent  = total;
  document.getElementById('stat-wins').textContent   = ME.wins   || 0;
  document.getElementById('stat-losses').textContent = ME.losses || 0;

  // Settings toggles
  document.getElementById('toggle-advanced').checked = !!ME.advancedMode;

  // Match history
  loadHistory(user.uid);
}

// ── Name editing ─────────────────────────────────────────────
document.getElementById('btn-edit-name').onclick = () => {
  document.getElementById('name-edit-row').classList.add('show');
  document.getElementById('name-input').focus();
};
document.getElementById('btn-cancel-name').onclick = () => {
  document.getElementById('name-edit-row').classList.remove('show');
};
document.getElementById('btn-save-name').onclick = async () => {
  const newName = document.getElementById('name-input').value.trim();
  if (!newName || newName.length < 2) { alert('Name must be at least 2 characters.'); return; }
  await update(ref(db, `players/${USER.uid}`), { name: newName });
  ME.name = newName;
  document.getElementById('display-name').textContent = newName;
  document.getElementById('name-edit-row').classList.remove('show');
};

// ── Settings ─────────────────────────────────────────────────
document.getElementById('toggle-advanced').onchange = async function() {
  await update(ref(db, `players/${USER.uid}`), { advancedMode: this.checked });
};

// ── Match history ─────────────────────────────────────────────
async function loadHistory(uid) {
  const snap = await get(ref(db, `matchHistory/${uid}`));
  const container = document.getElementById('match-history');
  if (!snap.exists()) return; // keep "no matches" text

  const matches = Object.values(snap.val()).sort((a, b) => b.timestamp - a.timestamp).slice(0, 20);
  container.innerHTML = '';
  matches.forEach(m => {
    const row = document.createElement('div');
    row.className = 'match-row';
    const eloStr = m.eloDelta >= 0 ? `+${m.eloDelta}` : `${m.eloDelta}`;
    const date   = new Date(m.timestamp).toLocaleDateString();
    row.innerHTML = `
      <span class="match-result ${m.result}">${m.result.toUpperCase()}</span>
      <span class="match-opp">vs ${escHtml(m.opponentName)}</span>
      <span class="match-elo" style="color:${m.eloDelta >= 0 ? 'var(--green)' : 'var(--p2)'}">${eloStr} ELO</span>
      <span class="match-date">${date}</span>`;
    container.appendChild(row);
  });
}

// ── Sign out ─────────────────────────────────────────────────
async function doSignOut() {
  await signOut(auth);
  window.location.href = 'index.html';
}
document.getElementById('btn-signout').onclick  = (e) => { e.preventDefault(); doSignOut(); };
document.getElementById('btn-signout2').onclick = doSignOut;

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
</script>
</body>
</html>
